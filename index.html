<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES 모니터링</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            background-color: #1a1a2e;
            color: white;
            font-family: Arial;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .cards {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: #16213e;
            padding: 20px;
            border-radius: 10px;
            flex: 1;
            text-align: center;
        }
        
        .card h3 {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .card .value {
            font-size: 32px;
            font-weight: bold;
        }
        
        .sensors {
            background-color: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .sensors h2 {
            margin-bottom: 20px;
        }
        
        .sensor-grid {
            display: flex;
            gap: 20px;
        }
        
        .sensor {
            flex: 1;
            text-align: center;
        }
        
        .sensor h4 {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .sensor .number {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .chart-box {
            background-color: #16213e;
            padding: 20px;
            border-radius: 10px;
        }
        
        .chart-box h2 {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>MES 실시간 모니터링</h1>
    
    <!-- 요약 카드 -->
    <div class="cards">
        <div class="card">
            <h3>설비 상태</h3>
            <div class="value" id="status" style="color: #00ff00;">RUN</div>
        </div>
        <div class="card">
            <h3>금일 생산량</h3>
            <div class="value" id="production">0개</div>
        </div>
        <div class="card">
            <h3>활성 알람</h3>
            <div class="value" id="alarm" style="color: #ff4444;">0건</div>
        </div>
        <div class="card">
            <h3>불량률</h3>
            <div class="value" id="defect">0%</div>
        </div>
    </div>
    
    <!-- 센서 데이터 -->
    <div class="sensors">
        <h2>센서 데이터 (설비 ID: <span id="equipId">EQ-001</span>)</h2>
        <div class="sensor-grid">
            <div class="sensor">
                <h4>온도</h4>
                <div class="number" id="temp" style="color: #00ff00;">0</div>
                <div>°C</div>
            </div>
            <div class="sensor">
                <h4>압력</h4>
                <div class="number" id="press" style="color: #4444ff;">0</div>
                <div>PSI</div>
            </div>
            <div class="sensor">
                <h4>진동</h4>
                <div class="number" id="vib" style="color: #ff44ff;">0</div>
                <div>Hz</div>
            </div>
            <div class="sensor">
                <h4>속도</h4>
                <div class="number" id="spd" style="color: #44ffff;">0</div>
                <div>RPM</div>
            </div>
        </div>
    </div>
    
    <!-- 생산량 차트 -->
    <div class="chart-box">
        <h2>분당 생산량</h2>
        <canvas id="chart" height="80"></canvas>
    </div>

    <script>
        // API 주소
        var API = 'http://localhost:8080/api/dashboard';
        var myChart = null;
        
        // 센서 데이터 가져오기
        function getSensor() {
            $.ajax({
                url: API + '/sensor-latest',
                success: function(data) {
                    $('#equipId').text(data.equipmentId);
                    $('#temp').text(data.temperature.toFixed(1));
                    $('#press').text(data.pressure.toFixed(1));
                    $('#vib').text(data.vibration.toFixed(1));
                    $('#spd').text(data.speed.toFixed(1));
                    
                    // 온도가 높으면 빨간색
                    if (data.temperature > 42) {
                        $('#temp').css('color', '#ff4444');
                    } else {
                        $('#temp').css('color', '#00ff00');
                    }
                }
            });
        }
        
        // 요약 데이터 가져오기
        function getSummary() {
            $.ajax({
                url: API + '/summary',
                success: function(data) {
                    $('#status').text(data.equipmentStatus);
                    $('#production').text(data.todayProduction + '개');
                    $('#alarm').text(data.activeAlarmCount + '건');
                    $('#defect').text(data.defectRate + '%');
                }
            });
        }
        
        // 생산량 차트 그리기
        function getChart() {
            $.ajax({
                url: API + '/production-chart',
                success: function(data) {
                    var times = [];
                    var counts = [];
                    
                    for (var i = 0; i < data.length; i++) {
                        times.push(data[i][0].substring(11, 16));
                        counts.push(data[i][1]);
                    }
                    
                    if (myChart) {
                        myChart.destroy();
                    }
                    
                    var ctx = document.getElementById('chart').getContext('2d');
                    myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: times,
                            datasets: [{
                                data: counts,
                                backgroundColor: '#4444ff'
                            }]
                        },
                        options: {
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }
            });
        }
        
        // 시작할 때 한번 실행
        $(document).ready(function() {
            getSensor();
            getSummary();
            getChart();
            
            // 2초마다 센서 갱신
            setInterval(getSensor, 2000);
            
            // 5초마다 요약 갱신
            setInterval(getSummary, 5000);
            
            // 10초마다 차트 갱신
            setInterval(getChart, 10000);
        });
    </script>
</body>
</html>
